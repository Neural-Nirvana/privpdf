<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test PDF Protection Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .method-test {
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .method-test.valid-pdf {
            border-color: #4caf50;
            background: #f1f8e9;
        }
        .method-test.encrypted-container {
            border-color: #ff9800;
            background: #fff8e1;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç PDF Protection Fix Test</h1>
        <p>Test different protection methods to verify which create valid PDFs vs encrypted containers</p>
        
        <div class="upload-area">
            <input type="file" id="fileInput" accept=".pdf">
            <button class="btn" onclick="document.getElementById('fileInput').click()">Select PDF File</button>
        </div>
        
        <div id="testResults"></div>
    </div>

    <!-- Load libraries -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="pdf-protection.js"></script>
    <script>
        let selectedFile = null;
        let pdfProtection = null;

        document.addEventListener('DOMContentLoaded', function() {
            pdfProtection = new PDFProtection();
            
            document.getElementById('fileInput').addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    selectedFile = e.target.files[0];
                    runTests();
                }
            });
        });

        async function runTests() {
            if (!selectedFile) return;
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<h2>Testing Protection Methods...</h2>';
            
            const arrayBuffer = await selectedFile.arrayBuffer();
            
            // Test each method
            const methods = [
                { id: 'watermark', name: 'Watermark Protection', expected: 'valid-pdf' },
                { id: 'metadata', name: 'Metadata Protection', expected: 'valid-pdf' },
                { id: 'encryption', name: 'AES-256 Encryption', expected: 'encrypted-container' }
            ];
            
            for (const method of methods) {
                try {
                    const result = await pdfProtection.protectPDF(arrayBuffer, {
                        method: method.id,
                        userPassword: method.id === 'encryption' ? 'test123' : '',
                        permissions: {
                            print: true,
                            copy: false,
                            modify: false,
                            annotate: false
                        }
                    });
                    
                    // Check if result is a valid PDF
                    const isValidPDF = checkIfValidPDF(result.data);
                    const statusClass = isValidPDF ? 'valid-pdf' : 'encrypted-container';
                    const expectedMatch = statusClass === method.expected;
                    
                    resultsDiv.innerHTML += `
                        <div class="method-test ${statusClass}">
                            <h3>${method.name}</h3>
                            <div class="status ${expectedMatch ? 'success' : 'error'}">
                                <strong>Result:</strong> ${isValidPDF ? 'Valid PDF (can open in PDF viewers)' : 'Encrypted Container (needs PrivPDF to open)'}
                                <br><strong>Expected:</strong> ${method.expected.replace('-', ' ')}
                                <br><strong>Match:</strong> ${expectedMatch ? '‚úÖ Correct' : '‚ùå Unexpected'}
                            </div>
                            <p><strong>Method Used:</strong> ${result.method}</p>
                            <p><strong>Size:</strong> ${formatFileSize(selectedFile.size)} ‚Üí ${formatFileSize(result.data.byteLength)}</p>
                            <p><strong>Note:</strong> ${result.note || 'No additional notes'}</p>
                            <button class="btn" onclick="downloadTest('${method.id}', '${method.name}')">Download Test File</button>
                        </div>
                    `;
                    
                    // Store result for download
                    window[`testResult_${method.id}`] = result.data;
                    
                } catch (error) {
                    resultsDiv.innerHTML += `
                        <div class="method-test">
                            <h3>${method.name}</h3>
                            <div class="status error">
                                <strong>Error:</strong> ${error.message}
                            </div>
                        </div>
                    `;
                }
            }
        }

        function checkIfValidPDF(data) {
            // Check for PDF header
            const header = new Uint8Array(data.slice(0, 5));
            const headerStr = String.fromCharCode(...header);
            return headerStr === '%PDF-';
        }

        function downloadTest(methodId, methodName) {
            const data = window[`testResult_${methodId}`];
            if (data) {
                const blob = new Blob([data], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `test_${methodId}_${methodName.replace(/\s+/g, '_')}.pdf`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    </script>
</body>
</html>